# Flink 概述

### 主要内容

- 如何实现流式数据处理管道
- Flink 如何以及为何管理状态
- 如何使用事件时间来持续计算准确的分析结果
- 如何在连续流上构建事件驱动应用程序
- Flink 如何能够提供具有精确一次语义的容错有状态流处理

### 流处理

- 在分析数据时，可以围绕有界流或无界流组织处理，选择哪种模式会产生深远的影响
- 通常，程序中的转换与数据流中的操作符之间存在一一对应关系。然而，**有时一个转换可能由多个操作符组成**。

### 并行数据流

- Flink 中的程序本质上是并行和分布式的。在执行期间，一个流有一个或多个流分区，每个操作符有一个或多个操作符子任务。操作符子任务彼此独立，在不同线程中执行，并且可能在不同机器或容器上执行。

- 操作符子任务的数量就是该特定操作符的并行度。**同一程序的不同操作符可能具有不同的并行度**。

- 流可以以**一对一**（或**转发**）模式或**重分布**模式在两个操作符之间传输数据：重分布流会改变流的分区。每个操作符子任务会根据所选的转换将**数据发送到不同的目标子任务**。例如 **keyBy ()**（它通过对键进行**哈希**来重新分区）、**broadcast ()** 或 **rebalance ()**（它随机地重新分区）。在重分布交换中，元素之间的顺序仅在每对发送和接收子**任务内**得以保留。因此，例如，上述所示的 keyBy/window 和汇操作符之间的重分布会导致不同键的聚合结果到达汇的顺序具有**不确定性**
  <img src="article/flink/picture/parallel_dataflow.svg" alt="图片alt" title="并行数据流图">

### 及时流处理

- 能够使用处理实时数据的相同代码重新处理历史数据，并且无论如何都能产生确定性的、一致的结果
- 通过使用数据流中记录的**事件时间戳**，而非**处理数据**的机器的时钟，就可以满足及时流处理的这些要求。

### 有状态的流处理

- Flink 的操作可以是**有状态的**。这意味着一个事件的处理方式可能取决于在它之前的所有事件累积产生的效果。
- 一个**有状态**操作符的并行实例集实际上是一个**分片的**键 - 值存储。每个并行实例负责处理特定键组的事件，并且这些键的状态保存在本地。
- 状态总是在**本地**被访问，这有助于 Flink 应用程序实现高吞吐量和低延迟。你可以选择将状态保存在 **JVM 堆**中，如果状态太大，也可以选择保存在高效组织的**磁盘**数据结构中。
- 为了**保证容错性**，状态会定期以**异步和增量**的方式进行快照，并存储到**持久化存储**中。这种机制使得 Flink 能够高效地处理有状态的流数据，并且在发生故障时能够**快速恢复状态**，继续处理数据。

### 通过状态快照实现容错

- Flink 能够通过结合**状态快照**和**流重放**来提供**容错且精确一次（exactly - once）的语义**。这些快照会捕获分布式数据处理管道的整个状态，记录输入队列中的偏移量，以及到该时刻为止摄取数据所产生的整个作业图中的状态。当发生故障时，数据源会回退，状态得到恢复，然后处理继续进行。如上文所述，这些状态快照是异步捕获的，不会妨碍正在进行的处理。

-  状态快照（State Snapshots）

  - 定义
    - 状态快照是在某一时刻对 Flink 作业状态的一个完整记录。它不仅包括操作符中的状态数据（例如计数器的值、中间聚合结果等），还包括输入流的位置信息（即输入队列中的偏移量）。
  - 目的
    - 当系统出现故障时，可以根据状态快照将作业恢复到拍摄快照时的状态。

  - 流重放（Stream Replay）

  - 原理
    - Flink 的数据源（如消息队列）通常是可重放的。这意味着在发生故障后，Flink 可以让数据源从之前记录的偏移量位置重新开始发送数据。
  - 作用
    - 结合状态快照，流重放确保了在故障恢复后，数据能够从正确的位置重新处理，从而保证计算的准确性。

  - 精确一次语义（Exactly - once Semantics）

  - 含义
    - 精确一次语义是指每个数据记录在整个数据处理流程中只会被精确地处理一次，不多也不少。这对于很多对数据准确性要求很高的应用场景（如金融交易处理）至关重要。
  - 实现方式
    - Flink 通过状态快照和流重放机制来保证精确一次语义。在正常处理过程中，Flink 会定期异步地拍摄状态快照，记录下当前作业的所有状态和输入位置。当出现故障时，作业可以从最近的状态快照恢复，并让数据源从快照记录的偏移量位置重放数据，确保数据处理的准确性和一致性。

  - 异步捕获状态快照

  - 优点
    - 状态快照是异步捕获的，这意味着拍摄快照的操作不会阻塞 Flink 作业的正常数据处理流程。作业可以在拍摄快照的同时继续处理数据，从而保证了处理的高效性和实时性。

  例如，假设有一个 Flink 作业在处理来自 Kafka 的数据流，作业对数据进行窗口聚合操作。Flink 会定期拍摄状态快照，记录下当前窗口的聚合结果和 Kafka 的偏移量。如果在处理过程中某个节点出现故障，Flink 可以从最近的状态快照恢复，让 Kafka 从记录的偏移量重新发送数据，然后继续进行窗口聚合操作，确保每个数据只被聚合一次，且处理过程不会因为拍摄快照而中断。

