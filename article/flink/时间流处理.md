### 时间概念：事件时间和处理时间

处理时间：处理时间指的是执行相应操作的机器的系统时间。

处理时间是最简单时间概念，不需要流和机器之间的协调。它提供了**最佳性能和最低延迟**。然而，在分布式和异步环境中，处理时间不提供确定性，因为它容易受到记录到达系统的速度（例如来自消息队列）、记录在系统内部操作符之间流动的速度以及停机（计划内或计划外）的影响。

事件时间程序必须指定如何生成**事件时间水印（Event Time Watermarks）**，这是指示事件时间进展的机制。

**事件时间处理将产生完全一致和确定性的结果，无论事件何时到达或它们的顺序如何**。然而，除非事件已知按时间戳顺序到达，否则事件时间处理在等待乱序事件时会产生一些延迟。由于只能**等待有限的时间**，这限制了事件时间应用程序可以有**多确定性**
<img src="article/flink/picture/事件驱动流处理系统的工作流程.png" alt="图片alt" title="事件驱动流处理系统的工作流程">

以下是图片中各个部分的描述：

1. **Event Producer（事件生产者）**：
   - 左侧的图标表示事件的生产者，例如传感器、移动设备或应用程序，它们生成数据事件。
2. **Event Time（事件时间）**：
   - 事件生产者旁边的时钟图标表示事件发生的时间，这是数据产生时的实际时间。
3. **Message Queue（消息队列）**：
   - 事件被发送到消息队列中，如 Kafka 或 RabbitMQ。消息队列中的两个分区（partition 1 和 partition 2）存储了来自事件生产者的事件。
4. **Flink Data Source（Flink 数据源）**：
   - Flink 从消息队列中消费数据，数据源负责读取事件并将其送入 Flink 处理引擎。
5. **Flink Window Operator（Flink 窗口操作符）**：
   - 数据流经 Flink 数据源处理后，进入窗口操作符。窗口操作符根据事件时间对事件进行窗口化处理。图中显示了两个窗口操作符，它们从数据源接收数据，并根据事件时间将数据分到不同的窗口中。
6. **Window Processing Done（窗口处理完成）**：
   - 窗口操作完成后，处理结果可以被发送到外部系统或存储。

### 事件时间和水印 

Flink 中衡量事件时间进展的机制是水印。水印作为数据流的一部分流动，并携带时间戳 t。水印 Watermark(t) 声明该流中的事件时间已经达到时间 t，这意味着流中不应该再有来自该流的时间戳 t' <= t 的元素（即时间戳较旧或等于水印的事件）。

### 并行流中的水印

水印是在**源函数处生成的**，或者直接在**源函数之后生成**。源函数的每个并行子任务通常会独立生成**自己的水印**。这些水印定义了特定并行源的时间。

当水印流经整个流处理程序时，它们会推进到达的操作符中的事件时间。每当操作符推进其事件时间时，它就会为其后续操作符生成一个新的水印。

一些操作符会消耗多个输入流；例如，**联合操作符**，或者在 keyBy(...) 或 partition(...) 函数之后的运算符。这样的操作符的**当前事件时间是其输入流事件时间的最小值**。随着其输入流更新事件时间，操作符也会相应更新。
<img src="article/flink/picture/并行流中的水印.png" alt="图片alt" title="并行流中的水印">



### 延迟元素（迟到）

有可能某些元素会违反水印条件，这意味着即使在 Watermark(t) 已经发生之后，更多具有时间戳 t' <= t 的元素仍会出现。实际上，在许多现实世界的设置中，某些元素可能会被任意延迟，使得无法指定一个时间点，在此时间点之前，某个事件时间戳的所有元素都将发生。此外，即使延迟可以被限制，过多地延迟水印通常也是不可取的，因为它会导致事件时间窗口的评估延迟过长。



### 窗口化

在流上聚合事件（例如计数、求和）与批处理中的工作方式不同。例如，不可能计算流中的所有元素，因为流通常是无限的（无界）。相反，流上的聚合（计数、求和等）是通过窗口来限定范围的，例如“过去5分钟内的计数”或“过去100个元素的总和”。

窗口可以是时间驱动的（例如：每30秒）或数据驱动的（例如：每100个元素）。人们通常区分不同类型的窗口，例如无重叠的滚动窗口（tumbling windows）、有重叠的滑动窗口（sliding windows）以及由不活动间隙分隔的会话窗口（session windows）。